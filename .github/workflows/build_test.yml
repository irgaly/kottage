# コミットごとに Unit Test 実行
name: Build & Test

on: push

jobs:
  build-test:
    strategy:
      fail-fast: false
      matrix:
        platform: [ ubuntu-latest, macos-11, windows-latest ]
    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: ./.github/actions/gradle-cache
      - name: JVM Build
        run: |
          ./gradlew jvmTestClasses
      - name: JS Browser / Nodejs Build
        run: |
          ./gradlew jsTestClasses
      - name: Android Build
        if: matrix.platform == 'macos-11'
        run: |
          ./gradlew packageDebugAndroidTest
      - name: Windows Build
        if: matrix.platform == 'windows-latest'
        run: |
          C:/msys64/usr/bin/pacman -S --noconfirm mingw-w64-x86_64-sqlite3
          ./gradlew linkDebugTestMingwX64
      - name: iOS Build
        if: matrix.platform == 'macos-11'
        run: |
          ./gradlew linkDebugTestIosX64
      - name: macOS Build
        if: matrix.platform == 'macos-11'
        run: |
          ./gradlew linkDebugTestMacosX64
      - name: JVM Test
        run: |
          ./gradlew jvmTest
      - name: install python3 setuptools
        if: matrix.platform == 'macos-11'
        run: |
          # https://github.com/WiseLibs/better-sqlite3/pull/1100
          python3 -m pip install setuptools
      - name: JS Nodejs Test
        run: |
          ./gradlew jsNodeTest
      - name: JS Browser
        if: matrix.platform == 'macos-11'
        run: |
          ./gradlew jsBrowserTest
      - name: Android Test
        uses: reactivecircus/android-emulator-runner@v2
        if: matrix.platform == 'macos-11'
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          script: |
            ./gradlew connectedDebugAndroidTest
      - name: Windows Test
        if: matrix.platform == 'windows-latest'
        run: |
          cp -f C:/msys64/mingw64/bin/libsqlite3-0.dll kottage/build/bin/mingwX64/debugTest/
          ./gradlew mingwX64Test
      - name: iOS Test
        if: matrix.platform == 'macos-11'
        run: |
          ./gradlew iosX64Test
      - name: macOS Test
        if: matrix.platform == 'macos-11'
        run: |
          ./gradlew macosX64Test
      - name: Stop Gradle on Windows
        if: matrix.platform == 'windows-latest'
        run: |
          # Windows で gradle cache を保存するために
          # .gradle/caches/8.0/kotlin-dsl/kotlin-dsl.lock の使用中ロックを解除する
          ./gradlew --stop
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.platform }}
          path: |
            **/build/test-results/*/*.xml
            **/build/reports/tests/*
  publish-test-results:
    needs: build-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/download-artifact@v3
      - uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          junit_files: "**/test-results/*/*.xml"
          comment_mode: off
