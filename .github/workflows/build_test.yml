# コミットごとに Unit Test 実行
name: Build & Test

on: push

jobs:
  build-test:
    strategy:
      fail-fast: false
      matrix:
        platform: [ ubuntu-latest, macos-latest, windows-latest ]
    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: temurin
          java-version: 17
      - uses: ./.github/actions/gradle-cache
      - name: JVM Build
        run: |
          ./gradlew jvmTestClasses
      - name: JS Browser / Nodejs Build
        run: |
          ./gradlew jsTestClasses
      - name: Android Build
        if: contains(matrix.platform, 'ubuntu')
        run: |
          ./gradlew packageDebugAndroidTest
      - name: Linux Test Build
        if: contains(matrix.platform, 'ubuntu')
        run: |
          ./gradlew linkDebugTestLinuxX64
      - name: Windows Build
        if: contains(matrix.platform, 'windows')
        run: |
          C:/msys64/usr/bin/pacman -S --noconfirm mingw-w64-x86_64-sqlite3
          ./gradlew linkDebugTestMingwX64
      - name: iOS Build
        if: contains(matrix.platform, 'macos')
        run: |
          ./gradlew linkDebugTestIosSimulatorArm64
      - name: macOS Build
        if: contains(matrix.platform, 'macos')
        run: |
          ./gradlew linkDebugTestMacosArm64
      - name: JVM Test
        run: |
          ./gradlew jvmTest
      - name: install python3 setuptools
        if: contains(matrix.platform, 'macos')
        run: |
          # https://github.com/WiseLibs/better-sqlite3/pull/1100
          brew install python-setuptools
      - name: JS Nodejs Test
        run: |
          ./gradlew jsNodeTest
      - name: JS Browser
        if: contains(matrix.platform, 'macos')
        run: |
          ./gradlew jsBrowserTest
      - name: Enable KVM group for Android Emulator
        if: contains(matrix.platform, 'ubuntu')
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Android Test
        uses: reactivecircus/android-emulator-runner@1dcd0090116d15e7c562f8db72807de5e036a4ed # v2.34.0
        if: contains(matrix.platform, 'ubuntu')
        with:
          api-level: 29
          script: ./gradlew connectedDebugAndroidTest
      - name: Linux Test
        if: contains(matrix.platform, 'ubuntu')
        run: |
          ./gradlew linuxX64Test
      - name: Windows Test
        if: contains(matrix.platform, 'windows')
        run: |
          cp -f C:/msys64/mingw64/bin/libsqlite3-0.dll kottage/build/bin/mingwX64/debugTest/
          ./gradlew mingwX64Test
      - name: iOS Test
        if: contains(matrix.platform, 'macos')
        run: |
          ./gradlew iosSimulatorArm64Test
      - name: macOS Test
        if: contains(matrix.platform, 'macos')
        run: |
          ./gradlew macosArm64Test
      - name: Stop Gradle on Windows
        if: contains(matrix.platform, 'windows')
        run: |
          # Windows で gradle cache を保存するために
          # .gradle/caches/8.0/kotlin-dsl/kotlin-dsl.lock の使用中ロックを解除する
          ./gradlew --stop
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: test-results-${{ matrix.platform }}
          path: |
            **/build/test-results/*/*.xml
            **/build/reports/tests/*
  publish-test-results:
    needs: build-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
      - uses: EnricoMi/publish-unit-test-result-action@3a74b2957438d0b6e2e61d67b05318aa25c9e6c6 # v2.20.0
        with:
          junit_files: "**/test-results/*/*.xml"
          comment_mode: off
